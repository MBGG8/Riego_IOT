<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ESP32 Dashboard</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="{{ url_for('static', filename='style.css') }}" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    .chart-card {
      background: white;
      border-radius: 15px;
      box-shadow: 0 4px 8px rgb(0 0 0 / 0.1);
      padding: 2rem;
      margin-bottom: 2rem;
      margin-left: 3rem;
      margin-right: 3rem;
      height: 350px;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }
    .chart-card canvas {
      max-height: 280px;
      width: 100% !important;
    }
    .navbar-dark {
      background-color: #1f1f2e;
    }
  </style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark">
  <div class="container-fluid">
    <a class="navbar-brand" href="/">ðŸ’§ Riego IOT</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse justify-content-end" id="navbarNav">
      <ul class="navbar-nav">
        <li class="nav-item">
          <a class="nav-link active" href="/">Dashboard</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/historiaIOT">Historial</a>
        </li>
      </ul>
    </div>
  </div>
</nav>

<div class="container mt-4">
  <h1 class="text-center mb-4">Dashboard de Riego AutomÃ¡tico</h1>

  <div id="error-message" class="alert alert-warning text-center d-none" role="alert">
    No se recibieron datos del servidor.
  </div>

  <div class="row mb-4" id="sensor-cards">
    <!-- Sensor cards (igual que antes, no modificadas) -->
    <div class="col-md-3 mb-3">
      <div class="card text-white bg-danger sensor-card">
        <div class="card-body text-center">
          <h5 class="card-title">Temperatura (Â°C)</h5>
          <p class="card-text fs-4" id="temp-value">--</p>
        </div>
      </div>
    </div>
    <div class="col-md-3 mb-3">
      <div class="card text-white bg-success sensor-card">
        <div class="card-body text-center">
          <h5 class="card-title">Humedad del Suelo (%)</h5>
          <p class="card-text fs-4" id="hum-suelo-value">--</p>
        </div>
      </div>
    </div>
    <div class="col-md-3 mb-3">
      <div class="card text-white bg-info sensor-card">
        <div class="card-body text-center">
          <h5 class="card-title">Humedad Ambiental (%)</h5>
          <p class="card-text fs-4" id="hum-ambiental-value">--</p>
        </div>
      </div>
    </div>
    <div class="col-md-3 mb-3">
      <div class="card text-white bg-warning sensor-card">
        <div class="card-body text-center">
          <h5 class="card-title">Luminosidad</h5>
          <p class="card-text fs-4" id="luz-value">--</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Card de riego con botÃ³n -->
  <div class="row mb-4">
    <div class="col-md-6 offset-md-3">
      <div id="riego-card" class="card text-white bg-danger text-center">
        <div class="card-body">
          <h5 class="card-title">Estado de Riego</h5>
          <p class="card-text fs-4" id="riego-value">Inactivo</p>
          <button id="toggle-riego-btn" class="btn btn-light mt-3 px-4">
            Cambiar Estado
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<h2 class="text-center mb-4">Historial de Datos</h2>
<div class="container mt-4">
  <div class="row justify-content-center g-4">
    <div class="col-md-5 chart-card">
      <canvas id="tempChart"></canvas>
    </div>
    <div class="col-md-5 chart-card">
      <canvas id="humSueloChart"></canvas>
    </div>
    <div class="col-md-5 chart-card">
      <canvas id="humAmbChart"></canvas>
    </div>
    <div class="col-md-5 chart-card">
      <canvas id="luzChart"></canvas>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
  function actualizarEstadoRiego(estado) {
    const card = document.getElementById("riego-card");
    const text = document.getElementById("riego-value");

    if (estado === true || estado === "true") {
      text.innerText = "Activo";
      card.classList.remove("bg-danger");
      card.classList.add("bg-success");
    } else {
      text.innerText = "Inactivo";
      card.classList.remove("bg-success");
      card.classList.add("bg-danger");
    }
  }

  function obtenerEstadoRiego() {
    fetch('/estado')
      .then(res => res.json())
      .then(data => actualizarEstadoRiego(data.activar))
      .catch(() => console.warn('No se pudo obtener el estado de riego'));
  }

  document.getElementById("toggle-riego-btn").addEventListener("click", () => {
    fetch("/toggle-riego", { method: "POST" })
      .then(res => res.json())
      .then(data => actualizarEstadoRiego(data.activar))
      .catch(err => console.error("Error al cambiar el estado:", err));
  });

  function obtenerDatosSensores() {
    fetch('/data')
      .then(res => res.json())
      .then(data => {
        if (!data || Object.keys(data).length === 0) {
          $('#error-message').removeClass('d-none');
          return;
        } else {
          $('#error-message').addClass('d-none');
        }
        if (data.temperatura !== undefined) {
          document.getElementById('temp-value').innerText = data.temperatura;
        }
        if (data.humedad_suelo !== undefined) {
          document.getElementById('hum-suelo-value').innerText = data.humedad_suelo;
        }
        if (data.humedad_ambiental !== undefined) {
          document.getElementById('hum-ambiental-value').innerText = data.humedad_ambiental;
        }
        if (data.luminosidad !== undefined) {
          document.getElementById('luz-value').innerText = data.luminosidad;
        }
      })
      .catch(() => {
        $('#error-message').removeClass('d-none');
      });
  }

  let tempChart, humSueloChart, humAmbChart, luzChart;

  async function cargarDatos() {
    const res = await fetch('/historico?timestamp=' + new Date().getTime());
    const datos = await res.json();

    const labels = datos.map(d => d.timestamp);
    const temp = datos.map(d => d.temperatura);
    const humSuelo = datos.map(d => d.humedad_suelo);
    const humAmb = datos.map(d => d.humedad_ambiental);
    const luz = datos.map(d => d.luminosidad);

    const crearGrafico = (id, label, data, color) => {
      return new Chart(document.getElementById(id), {
        type: 'line',
        data: { labels, datasets: [{ label, data, borderColor: color, fill: false }] },
        options: { responsive: true, maintainAspectRatio: false }
      });
    };

    if (tempChart) {
      tempChart.data.labels = labels;
      tempChart.data.datasets[0].data = temp;
      tempChart.update();
    } else {
      tempChart = crearGrafico('tempChart', 'Temperatura (Â°C)', temp, 'red');
    }

    if (humSueloChart) {
      humSueloChart.data.labels = labels;
      humSueloChart.data.datasets[0].data = humSuelo;
      humSueloChart.update();
    } else {
      humSueloChart = crearGrafico('humSueloChart', 'Humedad Suelo (%)', humSuelo, 'green');
    }

    if (humAmbChart) {
      humAmbChart.data.labels = labels;
      humAmbChart.data.datasets[0].data = humAmb;
      humAmbChart.update();
    } else {
      humAmbChart = crearGrafico('humAmbChart', 'Humedad Ambiental (%)', humAmb, 'blue');
    }

    if (luzChart) {
      luzChart.data.labels = labels;
      luzChart.data.datasets[0].data = luz;
      luzChart.update();
    } else {
      luzChart = crearGrafico('luzChart', 'Luminosidad', luz, 'orange');
    }
  }

  obtenerEstadoRiego();
  obtenerDatosSensores();
  cargarDatos();

  setInterval(() => {
    obtenerEstadoRiego();
    obtenerDatosSensores();
    cargarDatos();
  }, 10000);
</script>
</body>
</html>
